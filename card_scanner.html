<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>社員証読み取り</title>
    <script charset="utf-8" src="https://static.worksmobile.net/static/wm/woff/edge/3.6.2/sdk.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 20px;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            margin-top: 20px;
            cursor: pointer;
        }
        #result, #username {
            margin-top: 20px;
            font-size: 18px;
            color: #333;
        }
    </style>
</head>
<body>
    <div id="username">初期化中...</div>
    <button id="scan" disabled>QR コードをスキャン</button>
    <div id="result"></div>
    <script>
        const messages = {
            initializing: "初期化中...",
            scanQr: "QR コードをスキャン",
            initError: "アプリの初期化に失敗しました。",
            usernameDisplay: "ログイン中: ",
        };

        const scanButton = document.getElementById("scan");
        const usernameDiv = document.getElementById("username");
        const resultDiv = document.getElementById("result");

        // WOFF 初期化とユーザー名表示
        woff.init({ woffId: "xPHLCUnzH7Yl5kRx9B4ncw" })
            .then(async () => {
                try {
                    const profile = await woff.getProfile(); // ユーザー情報を取得
                    usernameDiv.textContent = `${messages.usernameDisplay}${profile.displayName}`;
                    scanButton.disabled = false; // スキャンボタンを有効化
                } catch (error) {
                    console.error("ユーザー情報取得エラー:", error);
                    usernameDiv.textContent = "ユーザー情報の取得に失敗しました。";
                }
            })
            .catch(error => {
                console.error("WOFF 初期化エラー:", error);
                usernameDiv.textContent = messages.initError;
            });

        // QR コードスキャン処理
        scanButton.addEventListener("click", async () => {
            scanButton.disabled = true; // ボタンを無効化
            scanButton.textContent = "スキャン中...";

            try {
                const scanData = await woff.scanQR(); // QR コードをスキャン
                const decodedData = atob(scanData.value);
                const result = JSON.parse(decodedData);
                resultDiv.textContent = `名前: ${result.displayName}, ID: ${result.userId}`;
            } catch (error) {
                console.error("スキャンエラー:", error);
                resultDiv.textContent = "スキャン中にエラーが発生しました。";
            } finally {
                scanButton.disabled = false; // ボタンを再有効化
                scanButton.textContent = messages.scanQr;
            }
        });
    </script>
</body>
</html>
